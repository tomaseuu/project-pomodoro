<!DOCTYPE html>
<html lang="en">
  <head>
    <title>FocusFruitPomodoro</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="index.css" />
  </head>

  <body class="pomodoro-page">
    <nav class="navbar">
      <a href="index.html" class="logo-link">
        <div class="logo-container">
          <img
            src="focus-fruit-logo.png"
            alt="Focus-Fruit Logo"
            class="logo-image"
          />
          <span class="logo-text">FocusFruit</span>
        </div>
      </a>
      <ul class="nav-list">
        <li><a href="pomodoro.html">Home</a></li>
        <li><a href="calendar.html">Calendar</a></li>
        <li>
          <a href="profile.html"
            ><img src="user-logo.png" alt="Profile" class="profile-icon"
          /></a>
        </li>
      </ul>
    </nav>

    <main class="main-content">
      <div id="root"></div>
      <div class="todolist-container">
        <h2 class="todolist-header">To-Do List</h2>
        <div class="add-task-container">
          <input type="text" id="taskInput" placeholder="Add a new task" />
          <button class="add-task-button" onclick="addTask()">Add</button>
        </div>
        <ul id="taskList" class="todo-items"></ul>
      </div>

      <div class="timer-guide-column">
        <div class="day-container">
          <h2 id="dateDisplayed" class="display-day"></h2>
        </div>
        <div class="timer-container">
          <form>
            <select
              id="timerOptions"
              class="timer-dropdown"
              onchange="changeTimer(this.value)"
            >
              <option value="25">Pomodoro</option>
              <option value="5">Short Break</option>
              <option value="30">Long Break</option>
              <option value="custom">Custom</option>
            </select>
          </form>
          <div id="timerDisplay" class="timer-display">25:00</div>
          <div class="timer-controls">
            <button id="startButton" onclick="startTimer()">Start</button>
            <button onclick="stopTimer()">Stop</button>
            <button onclick="resetTimer()">Reset</button>
          </div>
        </div>
        <div class="guide-container">
          <h3 class="guide-header">Pomodoro Guide</h3>
          <p>→ Set a timer for 25 minutes to focus on a task.</p>
          <p>→ When the timer ends, take a 5-minute break.</p>
          <p>→ Repeat this cycle 3 more times.</p>
          <p>→ After completing 4 cycles, take a longer 30-minute break.</p>
          <p>OR MAKE YOUR OWN RULES!!</p>
        </div>
      </div>
    </main>

    <script type="module" src="./src/Pomodoro.jsx"></script>

    <script>
      const API_PREFIX = "https://ashy-coast-0b352fa1e.5.azurestaticapps.net";

      //frontend functionality
      let time = 1500;
      let defaultTime = 1500;
      let isRunning = false;
      let timerInterval;
      let previousCustomTime = null;

      function startTimer() {
        console.log("Start button clicked");
        if (!isRunning) {
          isRunning = true;

          fetch("http://localhost:3000/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: "user123", timerId: "pomodoro" }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                console.log(data.message);
                timerInterval = setInterval(() => {
                  if (time > 0) {
                    time--;
                    updateTimerDisplay();
                  } else {
                    stopTimer();
                    playAudio();
                    previousCustomTime();
                    alert("Time's up!");
                  }
                }, 1000);
              } else {
                console.error("Error: ", data.message);
              }
            })
            .catch((error) =>
              console.error("Error communicating with backend: ", error)
            );
        }
      }

      function playAudio() {
        const audio = document.getElementById("timerEndAudio");
        audio.play();

        setTimeout(() => {
          audio.pause();
          audio.currentTime = 0;
        }, 10000);
      }

      function stopTimer() {
        if (isRunning) {
          isRunning = false;
          clearInterval(timerInterval);
        }

        fetch("http://localhost:3000/stop", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: "user123", timerId: "pomodoro" }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log(data.message);
              console.log(
                `Total elapsed time: ${data.totalElapsedTime} seconds`
              );
            } else {
              console.error("Error stopping timer: ", data.message);
            }
          })
          .catch((error) =>
            console.error("Error communicating with backend: ", error)
          );
      }

      function fetchElapsedTime() {
        fetch(`http://localhost:3000/total/${userId}/${timerId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log(
                `Total elapsed time: ${data.totalElapsedTime} seconds`
              );
              const elapsedSeconds = Math.floor(
                data.totalElapsedTime * 60 * 60
              );
              if (elapsedSeconds >= 1500 || elapsedSeconds === 0) {
                time = 1500;
              } else {
                time = Math.max(1500 - elapsedSeconds, 0);
              }
              updateTimerDisplay();
            } else {
              console.error("Error fetching elapsed time:", data.message);
            }
          })
          .catch((error) =>
            console.error("Error communicating with backend: ", error)
          );
      }

      function resetTimer() {
        stopTimer();
        if (defaultTime === "custom") {
          const resetPrompt = confirm(
            "Would you like to enter a new custom timer value?"
          );
          if (resetPrompt) {
            changeTimer("custom");
          } else {
            time = previousCustomTime;
          }
        } else {
          time = defaultTime;
        }
        updateTimerDisplay();
      }

      function resetTotalElapsedTime() {
        fetch("http://localhost:3000/resetElapsed", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: "user123", timerId: "pomodoro" }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log(data.message);
              time = 1500;
              updateTimerDisplay();
            } else {
              console.error("Error resetting elapsed time: ", data.message);
            }
          })
          .catch((error) =>
            console.error("Error communicating with backend: ", error)
          );
      }

      function updateTimerDisplay() {
        const minutes = String(Math.floor(time / 60)).padStart(2, "0");
        const seconds = String(time % 60).padStart(2, "0");
        document.getElementById(
          "timerDisplay"
        ).textContent = `${minutes}:${seconds}`;

        localStorage.setItem("remainingTime", time);
      }

      document.addEventListener("DOMContentLoaded", () => {
        const savedTime = localStorage.getItem("remainingTime");
        if (savedTime) {
          time = parseInt(savedTime, 10);
        } else {
          time = 1500;
        }
        updateTimerDisplay();
      });

      function changeTimer(value) {
        stopTimer();
        if (value === "custom") {
          let customMinutes;
          do {
            customMinutes = prompt("Enter custom minutes (1–300): ");
            if (customMinutes === null) {
              alert("You must enter a custom time. Please try again.");
            } else if (
              isNaN(customMinutes) ||
              customMinutes <= 0 ||
              customMinutes > 300
            ) {
              alert(
                "Invalid input. Please enter a number between 1 and 300 minutes."
              );
              customMinutes = null;
            }
          } while (customMinutes === null);

          time = customMinutes * 60;
          previousCustomTime = time;
          defaultTime = "custom";
        } else {
          time = value * 60;
          defaultTime = time;
        }
        updateTimerDisplay();
      }

      // todo list functionality
      const apiUrl = "http://localhost:3001/tasks";
      const userId = "user123";

      async function fetchTasks() {
        try {
          console.log("Current userId:", userId);
          console.log("Fetching tasks from:", `${apiUrl}?userId=${userId}`);
          const response = await fetch(`${apiUrl}?userId=${userId}`);
          console.log("result: ", response);

          if (!response.ok) throw new Error("Failed to fetch tasks");
          const result = await response.json();
          console.log("Tasks fetched successfully:", result);

          if (result.success) {
            console.log("result of fetch: ", result);
            renderTasks(result.tasks);
          } else {
            console.error(result.message);
          }
        } catch (error) {
          console.error("Error fetching task: ", error);
        }
      }

      async function addTask() {
        const taskInput = document.getElementById("taskInput");
        const taskText = taskInput.value.trim();

        if (taskText !== "") {
          try {
            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId, task: taskText }),
            });
            console.log("Adding task with data:", { userId, task: taskText });

            if (!response.ok) throw new Error("Failed to add task");
            const result = await response.json();

            if (result.success) {
              taskInput.value = "";
              fetchTasks();
            } else {
              console.error(result.message);
            }
          } catch (error) {
            console.error("Error adding task: ", error);
          }
        }
      }

      async function toggleTaskCompletion(taskId) {
        try {
          const response = await fetch(`${apiUrl}/${taskId}/toggle`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId }),
          });

          if (!response.ok)
            throw new Error("Failed to toggle task completion.");
          const result = await response.json();

          if (result.success) {
            fetchTasks();
          } else {
            console.error(result.message);
          }
        } catch (error) {
          console.error("Error toggling task completion:", error);
        }
      }

      async function removeTask(taskId) {
        try {
          const response = await fetch(`${apiUrl}/${taskId}?userId=${userId}`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId }),
          });
          console.log(
            "removeTask fetch link: ",
            `${apiUrl}/${taskId}?userId=${userId}`
          );
          console.log("removeTask response: ", response);

          if (!response.ok) throw new Error("Failed to remove task");
          const result = await response.json();

          if (result.success) {
            fetchTasks();
          } else {
            console.error(result.message);
          }
        } catch (error) {
          console.error("Error removing task: ", error);
        }
      }

      function renderTasks(tasks) {
        console.log("rendering tasks: ", tasks);
        const taskList = document.getElementById("taskList");
        taskList.innerHTML = "";

        tasks.forEach((task) => {
          console.log("task: ", task);
          const taskItem = document.createElement("p");
          taskItem.className = `todo-item ${task.completed ? "completed" : ""}`;

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = task.completed;
          checkbox.onclick = () => toggleTaskCompletion(task._id);

          const taskText = document.createElement("span");
          taskText.className = "task-text";
          taskText.textContent = task.task;

          const removeButton = document.createElement("button");
          removeButton.className = "remove-button";
          removeButton.textContent = "Remove";
          removeButton.onclick = () => removeTask(task._id);

          taskItem.appendChild(checkbox);
          taskItem.appendChild(taskText);
          taskItem.appendChild(removeButton);
          taskList.appendChild(taskItem);
        });
      }

      //display date on pomodoro page
      document.addEventListener("DOMContentLoaded", () => {
        const dateDisplayedElement = document.getElementById("dateDisplayed");
        const today = new Date();
        const displayed = today.toLocaleString("default", {
          month: "long",
          day: "numeric",
          year: "numeric",
        });
        dateDisplayedElement.textContent = displayed;
        fetchTasks();
      });
      
    </script>
  </body>
  <audio id="timerEndAudio" src="timer-end-sound.mp3" preload="auto"></audio>
  <footer class="footer">
    <p>
      <a href="contact.html">contact us</a>
    </p>
  </footer>
</html>
